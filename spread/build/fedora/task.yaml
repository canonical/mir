summary: Build Fedora packages
systems: [fedora-*]
variants: [amd64]
kill-timeout: 60m

execute: |
    if [[ "${SPREAD_SYSTEM}" == "fedora-rawhide" ]]; then
      dnf --refresh --assumeyes upgrade
      dnf --assumeyes install fedora-repos-rawhide
      dnf --refresh --assumeyes --enablerepo=rawhide distro-sync
    fi

    dnf --assumeyes install @buildsys-build ccache 'dnf5-command(builddep)'
    if [ "${CLANG}" -eq 1 ]; then
        dnf --assumeyes install clang
    fi

    dnf --assumeyes builddep --allowerasing ${SPREAD_PATH}/rpm/mir.spec

    pushd ${SPREAD_PATH}
    rpmbuild --build-in-place \
             --with ccache \
             --with debug \
             --with run_tests \
             --define "_vpath_builddir $SPREAD_PATH/../build" \
             -bb rpm/mir.spec
    popd

    ccache --show-stats --zero-stats > ${CCACHE_DIR}/ccache.stats
