summary: Build Fedora packages
systems: [fedora-*]
variants: [amd64]
kill-timeout: 60m

execute: |
    if [[ "${SPREAD_SYSTEM}" == "fedora-rawhide" ]]; then
      dnf --refresh --assumeyes upgrade
      dnf --assumeyes install fedora-repos-rawhide
      dnf --refresh --assumeyes --enablerepo=rawhide distro-sync
    fi

    dnf --assumeyes install @buildsys-build ccache 'dnf5-command(builddep)'
    if [ "${CLANG}" -eq 1 ]; then
        dnf --assumeyes install clang
    fi

    dnf --assumeyes builddep --allowerasing ${SPREAD_PATH}/rpm/mir.spec

    pushd ${SPREAD_PATH}
    rpmbuild --build-in-place \
             --with ccache \
             --with debug \
             --with run_tests \
             --define "_vpath_builddir $SPREAD_PATH/../build" \
             -bb rpm/mir.spec
    popd

    ccache --show-stats --zero-stats > ${CCACHE_DIR}/ccache.stats

    # build the local repository for end-to-end tests
    dnf --assumeyes install createrepo
    createrepo /root/rpmbuild
    dnf config-manager addrepo \
       --id=mirpr \
       --set=baseurl="file:///root/rpmbuild" \
       --set=gpgcheck=0 \
       --set=priority=90 \
       --set=enabled=1 \
       --save-filename=mirpr.repo
    dnf update

    export \
      MIR_SERVER_PLATFORM_DISPLAY_LIBS=mir:virtual \
      MIR_SERVER_VIRTUAL_OUTPUT=800x600

    # [doc:first-compositor:fedora-dependencies-install]
    dnf --assumeyes install bomber 'pkgconfig(miral)'
    # [doc:first-compositor:fedora-dependencies-install-end]

    cd ${SPREAD_PATH}/doc/sphinx/tutorial/first-wayland-compositor

    # [doc:first-compositor:build]
    cmake .
    cmake --build .
    # [doc:first-compositor:build-end]

    # we expect the timeout to hit
    timeout 10 bash -e <<EOF || [ $? -eq 124 ]

      trap "jobs -p | xargs -r kill" SIGINT SIGTERM EXIT

      # [doc:first-compositor:run]
      WAYLAND_DISPLAY=wayland-99 ./demo-mir-compositor &
      # [doc:first-compositor:run-end]

      # wait for the the socket
      timeout --preserve-status 3 bash -c "while [ ! -S $XDG_RUNTIME_DIR/wayland-99 ]; do sleep 0.1; done"

      # [doc:first-compositor:run-client]
      WAYLAND_DISPLAY=wayland-99 bomber
      # [doc:first-compositor:run-client-end]
    EOF
