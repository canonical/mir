name: Spread

on:
  push:
    branches:
    - main
    - release/[0-9]+.[0-9]+
    tags:
    - v[0-9]+[0-9]+.[0-9]+
  merge_group:
    types: [checks_requested]
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

concurrency:
  group: ${{ github.workflow }}-${{ github.event.number && format('pr{0}', github.event.number) || github.run_id }}
  cancel-in-progress: true

jobs:
  GetMatrix:
    runs-on: ubuntu-latest

    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}

    steps:
    - id: set-matrix
      name: Determine BuildAndTest matrix
      run: |
        set -euo pipefail

        if ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}; then
          TASKS='"lxd:ubuntu-24.04:spread/build/ubuntu:tsan"
                 "lxd:ubuntu-24.04:spread/build/ubuntu:tsan_clang"'
        fi

        TASKS+='"lxd:...:debian_sid"
                "lxd:...:fedora_42"
                "lxd:...:fedora_43"
                "lxd:...:fedora_clang"
                "lxd:...:fedora_rawhide"
                "lxd:...:spread/ubuntu:asan"
                "lxd:...:spread/ubuntu:asan_clang"
                "lxd:...:spread/ubuntu:clang"
                "lxd:...:spread/ubuntu:mold"
                "lxd:...:spread/ubuntu:ubsan"
                "lxd:...:spread/ubuntu:ubsan_clang"
                "lxd:...:ubuntu"
                "lxd:...:ubuntu_arm64"
                "lxd:...:ubuntu_armhf"
                "lxd:...:ubuntu_devel"
                "lxd:...:ubuntu_plucky"
                "lxd:...:ubuntu_proposed"
                "lxd:...:ubuntu_questing"
                "lxd:alpine-3.20:...:amd64"
                "lxd:alpine-3.21:...:amd64"
                "lxd:alpine-edge:...:amd64"'

        echo ${TASKS:-} | jq -cs '{ "spread-task": .  }' | awk '{ print "matrix=" $0 }' >> $GITHUB_OUTPUT

  BuildAndTest:
    needs: GetMatrix

    strategy:
      fail-fast: false
      matrix: ${{ fromJSON(needs.GetMatrix.outputs.matrix) }}

    runs-on: ubuntu-latest

    env:
      DEBFULLNAME: "Mir CI Bot"
      DEBEMAIL: "mir-ci-bot@canonical.com"
      SPREAD_PATH: "/tmp/spread"
      CCACHE_DIR: "/tmp/ccache"

    steps:
    - name: Set up LXD
      uses: canonical/setup-lxd@main

    - name: Set up Spread
      run: |
        sudo snap install spread-mir-ci
        sudo snap connect spread-mir-ci:lxd lxd:lxd
        lxc profile set default security.privileged=true security.nesting=true
        sudo apt-get update
        sudo apt-get install --yes binfmt-support qemu-user-static
        echo "LXD_DIR=/var/snap/lxd/common/lxd" >> $GITHUB_ENV

    - name: Check out code
      uses: actions/checkout@v6
      with:
        fetch-depth: 0

    - name: Set up CCache
      id: setup-ccache
      run: |
        mkdir --parents ${CCACHE_DIR}
        /snap/bin/lxc profile device add default ccache disk source=${CCACHE_DIR} path=/root/.ccache

        # Find the merge base to avoid populating the cache with short lived cache entries
        # and evicting those we care for - from `main`
        echo "merge-base=$( git merge-base origin/main ${{ github.sha }} )" >> $GITHUB_OUTPUT

    - name: CCache
      uses: actions/cache@v5
      with:
        key: ccache-${{ matrix.spread-task }}-${{ steps.setup-ccache.outputs.merge-base }}
        # if exact match isn't found, use the most recent entry for the task
        restore-keys: |
          ccache-${{ matrix.spread-task }}-
        path: ${{ env.CCACHE_DIR }}

    - name: Ensure ccache size
      run: |
        # a full build yielded at most 650M cache
        echo "max_size = 800M" > ${CCACHE_DIR}/ccache.conf

    - name: Run Spread task
      run: |
        tools/make_release_tarball --skip-checks
        snap run spread-mir-ci.spread -reuse -v ${{ matrix.spread-task }}

    - name: CCache stats
      run: cat ${CCACHE_DIR}/ccache.stats

    - if: ${{ failure() && runner.debug }}
      name: Setup upterm session
      uses: mxschmitt/action-tmate@v3
      with:
        limit-access-to-actor: true
