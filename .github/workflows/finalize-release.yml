name: Finalize Release

on:
  workflow_dispatch:
    inputs:
      release_branch:
        description: 'Release branch (e.g., release/2.24)'
        required: true
        type: string

permissions:
  contents: write

jobs:
  finalize:
    runs-on: ubuntu-latest

    env:
        DEBFULLNAME: ${{ vars.DEBFULLNAME }}
        DEBEMAIL: ${{ vars.DEBEMAIL }}

    steps:
      - name: Import GPG key
        uses: crazy-max/ghaction-import-gpg@v6
        with:
          gpg_private_key: ${{ secrets.MIR_BOT_GPG_PRIVATE_KEY }}
          passphrase: ${{ secrets.MIR_BOT_GPG_PASSPHRASE }}

      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          ref: ${{ inputs.release_branch }}

      - name: Configure git user
        run: |
          git config user.name "${{ vars.DEBFULLNAME }}"
          git config user.email "${{ vars.DEBEMAIL }}"

      - name: Determine version
        id: version
        run: |
          DESCRIBE=$(git describe --match="*-rc" --abbrev=0)
          if [[ "$DESCRIBE" =~ ^v([0-9]+\.[0-9]+\.[0-9]+)-rc$ ]]; then
            VERSION="${BASH_REMATCH[1]}"
            echo "version=$VERSION" | tee --append $GITHUB_OUTPUT
          else
            echo ":error: Failed to parse version from tag: $DESCRIBE"
            exit 1
          fi

      - name: Extract release notes
        run: |
          # Extract the section for this version from release-notes.md
          awk -v version="${{ steps.version.outputs.version }}" '
            /^## Mir / {
              if (in_section) exit
              if ($0 ~ version) {
                in_section = 1
                next
              }
            }
            in_section && /^## Mir / { exit }
            in_section { print }
          ' doc/sphinx/release-notes.md > /tmp/release-notes-section.md

      - name: Update Debian changelog
        run: |
          sudo apt-get update
          sudo apt-get install --yes devscripts

          # Ensure there's a matching "Begin development" entry
          dch --newversion "${{ steps.version.outputs.version }}~dev" \
            "Begin development for ${{ steps.version.outputs.version }} release"

          # Remove "Begin" lines and append release notes
          awk --include=inplace '
            /^mir \(${{ steps.version.outputs.version }}~dev\)/ {
              in_target = 1
              print
              print ""
              next
            }
            in_target && /^ -- / {
              while ((getline line < "/tmp/release-notes-section.md") > 0) {
                gsub(/^- /, "* ", line)
                gsub(/^      - /, "      . ", line)
                if (line != "") print "  " line
                else print ""
              }
              close("/tmp/release-notes-section.md")
              in_target = 0
              print ""
            }
            in_target && (/^$/ || /Begin development/) { next }
            { print }
          ' debian/changelog

          dch --newversion "${{ steps.version.outputs.version }}-0ubuntu24.04" \
              --distribution noble \
              --force-distribution \
              ""

          dch --release ""

      - name: Update RPM spec
        run: |
          DATE_STR=$(date '+%a %b %d %Y')

          # Update Version field and insert release notes
          awk --include=inplace --assign date_str="$DATE_STR" '
            function print_notes() {
                  while ((getline line < "/tmp/release-notes-section.md") > 0) {
                  print line
                }
                close("/tmp/release-notes-section.md")
                print ""
            }

            function print_header() {
              print "* " date_str " ${{ vars.DEBFULLNAME }} <${{ vars.DEBEMAIL }}> - ${{ steps.version.outputs.version }}-1"
            }

            /^Version:/ {
              print "Version:        ${{ steps.version.outputs.version }}"
              next
            }

            /%changelog/ {
              print
              getline
              if ($0 ~ /^\*.*${{ steps.version.outputs.version }}~dev-/) {
                # Replace existing ~dev entry
                print_header()
                getline
                while ($0 !~ /^\* /) {
                  if ($0 !~ /^$/ && $0 !~ /Begin development/) {
                    print
                  }
                  getline
                }
                print_notes()
              } else {
                # Prepend a new release entry
                print_header()
                print_notes()
              }
            }
            { print }
          ' rpm/mir.spec

      - name: Commit and push changelog
        run: |
          git add debian/changelog rpm/mir.spec
          git commit --gpg-sign --message "Update changelogs for ${{ steps.version.outputs.version }}"
          git push origin "${{ inputs.release_branch }}"

      - name: Finalize GitHub release
        uses: actions/github-script@v8
        with:
          script: |
            const tag = `v${{ steps.version.outputs.version }}`;

            const fs = require('fs');
            const releaseNotes = fs.readFileSync('/tmp/release-notes-section.md', 'utf8');

            // Get the release by iterating over releases (drafts aren't returned by tag)
            let release;
            const releases = await github.rest.repos.listReleases({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 10
            });

            release = releases.data.find(r => r.tag_name === tag);

            if (!release) {
              console.error(`:error: No draft release found with tag ${tag}`);
              process.exit(1);
            }

            await github.rest.repos.updateRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              release_id: release.id,
              body: releaseNotes,
              draft: true, // Keep as draft to allow manual review, for now
              prerelease: false
            });
            console.log(`:info: Updated release ${release.html_url}`);
