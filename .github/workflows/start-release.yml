name: Start Release

on:
  workflow_dispatch:
    inputs:
      sha:
        description: 'Commit SHA to release'
        required: true
        type: string
        default: 'main'
      version:
        description: 'Release version (e.g., 2.24.0)'
        required: true
        type: string

permissions:
  contents: write
  issues: write

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: Import GPG key
        uses: crazy-max/ghaction-import-gpg@v6
        with:
          gpg_private_key: ${{ secrets.MIR_BOT_GPG_PRIVATE_KEY }}

      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          ref: ${{ inputs.sha }}

      - name: Configure git user
        run: |
          git config user.name "${{ vars.DEBFULLNAME }}"
          git config user.email "${{ vars.DEBEMAIL }}"

      - name: Validate version and extract components
        id: version
        run: |
          if [[ "${{ inputs.version }}" =~ ^([0-9]+)\.([0-9]+)\.([0-9]+)$ ]]; then
            echo "major=${BASH_REMATCH[1]}" | tee --append $GITHUB_OUTPUT
            echo "minor=${BASH_REMATCH[2]}" | tee --append $GITHUB_OUTPUT
            echo "patch=${BASH_REMATCH[3]}" | tee --append $GITHUB_OUTPUT
            echo "release_branch=release/${BASH_REMATCH[1]}.${BASH_REMATCH[2]}" | tee --append $GITHUB_OUTPUT
          else
            echo ":error: Version '${{ inputs.version }}' is not in the format X.Y.Z"
            exit 1
          fi

      - name: Create release branch
        run: |
          git checkout -b ${{ steps.version.outputs.release_branch }}

      - name: Create release tag
        run: |
          git tag --annotate "v${{ inputs.version }}-rc" --message "Release candidate ${{ inputs.version }}" --sign "${{ inputs.sha }}"

      - name: Find previous release tag
        id: previous_tag
        run: |
          # Get the most recent tag excluding -rc and -dev tags
          PREVIOUS_TAG=$(git describe --abbrev=0 --exclude="*-rc" --exclude="*-dev" "${{ inputs.sha }}" 2>/dev/null || echo "")
          echo "tag=$PREVIOUS_TAG" | tee --append $GITHUB_OUTPUT

      - name: Create issue for release notes
        id: create_issue
        uses: actions/github-script@v7
        with:
          script: |
            const title = `Draft release notes for Mir ${{ inputs.version }}`;
            const lines = [
              `Please draft release notes for Mir ${{ inputs.version }} since ${{ steps.previous_tag.outputs.tag }}.`,
              ``,
              `Use the template at the beginning of \`doc/sphinx/release-notes.md\` to structure the release notes, and place them after the template.`,
              ``,
              `Target the pull request to the \`${{ steps.version.outputs.release_branch }}\` branch.`,
              ``,
              `Reference commit: ${{ inputs.sha }}`,
              `Release tag: v${{ inputs.version }}-rc`,
              `Previous release: ${{ steps.previous_tag.outputs.tag }}`
            ];
            const body = lines.join('\n');

            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              assignees: ["copilot"]
            });

            console.log(`:info: Created issue ${issue.data.html_url}`);
            return issue.data.html_url;

      - name: Push branch and tag
        run: |
          git push origin "v${{ inputs.version }}-rc"
          git push origin "${{ steps.version.outputs.release_branch }}"
